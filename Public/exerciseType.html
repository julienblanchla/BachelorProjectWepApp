<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exercise Session - Nordic Thingy</title>
  <link rel="stylesheet" href="/style/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .exercise-session-container {
      height: calc(100vh - 100px);
      display: flex;
      flex-direction: column;
      max-width: 900px; /* Réduit de 1000px */
      margin: 0 auto;
      gap: 0.8rem; /* Réduit de 1rem */
    }

    .exercise-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px; /* Réduit de 16px */
      box-shadow: 0 6px 24px rgba(0,0,0,0.08); /* Réduit */
      padding: 1.2rem; /* Réduit de 2rem */
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.8rem; /* Réduit de 1rem */
    }

    .exercise-info {
      display: flex;
      align-items: center;
      gap: 1rem; /* Réduit de 1.5rem */
    }

    .exercise-icon {
      font-size: 2.5rem; /* Réduit de 4rem */
      width: 60px; /* Réduit de 80px */
      height: 60px; /* Réduit de 80px */
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #ffffff, #f8f9fa);
      box-shadow: 0 3px 12px rgba(0,0,0,0.08); /* Réduit */
    }

    .exercise-details h1 {
      margin: 0 0 0.3rem 0; /* Réduit de 0.5rem */
      font-size: 1.4rem; /* Réduit de 2rem */
      color: #333;
    }

    .exercise-patient {
      font-size: 0.8rem; /* Réduit de 1rem */
      color: #666;
      background: rgba(0, 123, 255, 0.1);
      padding: 0.2rem 0.6rem; /* Réduit de 0.3rem 0.8rem */
      border-radius: 15px; /* Réduit de 20px */
    }

    .exercise-controls {
      display: flex;
      gap: 0.6rem; /* Réduit de 1rem */
      align-items: center;
    }

    .btn-exercise-action {
      padding: 0.6rem 1.2rem; /* Réduit de 1rem 2rem */
      border: none;
      border-radius: 6px; /* Réduit de 8px */
      font-size: 0.8rem; /* Réduit de 1.1rem */
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.3rem; /* Réduit de 0.5rem */
      box-shadow: 0 3px 12px rgba(0,0,0,0.08); /* Réduit */
    }

    .btn-start-session {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }

    .btn-stop-session {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
    }

    .btn-download-session {
      background: linear-gradient(135deg, #17a2b8, #138496);
      color: white;
    }

    .btn-back-exercises {
      background: linear-gradient(135deg, #6c757d, #495057);
      color: white;
      text-decoration: none;
    }

    .btn-exercise-action:hover {
      transform: translateY(-1px); /* Réduit de -2px */
      box-shadow: 0 4px 16px rgba(0,0,0,0.15); /* Réduit */
    }

    .motion-display {
      flex: 1;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px; /* Réduit de 16px */
      box-shadow: 0 6px 24px rgba(0,0,0,0.08); /* Réduit */
      padding: 1.2rem; /* Réduit de 2rem */
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-height: 0;
    }

    .motion-visual-large {
      width: 220px; /* Réduit de 300px */
      height: 220px; /* Réduit de 300px */
      border-radius: 12px; /* Réduit de 16px */
      margin: 0.8rem 0; /* Réduit de 1.5rem */
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12); /* Réduit */
      overflow: hidden;
      position: relative;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border: 3px solid rgba(255, 255, 255, 0.9); /* Réduit de 4px */
    }

    .motion-visual-large img {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 8px; /* Réduit de 12px */
    }

    .motion-visual-large.no-image {
      font-size: 3.5rem; /* Réduit de 5rem */
      color: #666;
      font-weight: bold;
    }

    .motion-description-large {
      font-size: 0.9rem; /* Réduit de 1.3rem */
      color: #666;
      margin-top: 0.6rem; /* Réduit de 1rem */
      padding: 0.6rem 0.8rem; /* Réduit de 1.2rem */
      background: rgba(248, 249, 250, 0.8);
      border-radius: 6px; /* Réduit de 10px */
      border-left: 3px solid #e9ecef; /* Réduit de 4px */
      max-width: 280px; /* Réduit de 400px */
      text-align: center;
      font-weight: 500;
    }

    .exercise-status {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px; /* Réduit de 16px */
      box-shadow: 0 6px 24px rgba(0,0,0,0.08); /* Réduit */
      padding: 1rem; /* Réduit de 1.5rem */
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.8rem; /* Réduit de 1rem */
    }

    .status-info {
      display: flex;
      gap: 1.2rem; /* Réduit de 2rem */
      align-items: center;
    }

    .status-item {
      text-align: center;
      background: rgba(248, 249, 250, 0.8);
      padding: 0.6rem 1rem; /* Réduit de 1rem 1.5rem */
      border-radius: 6px; /* Réduit de 8px */
      min-width: 60px; /* Réduit de 80px */
    }

    .status-item strong {
      display: block;
      color: #007bff;
      font-size: 1rem; /* Réduit de 1.4rem */
      font-weight: 700;
    }

    .status-item span {
      font-size: 0.7rem; /* Ajouté pour réduire les labels */
      color: #666;
      font-weight: 500;
    }

    .status-message {
      font-size: 0.8rem; /* Réduit de 1.1rem */
      font-weight: 600;
      padding: 0.6rem 1rem; /* Réduit de 1rem 1.5rem */
      border-radius: 6px; /* Réduit de 8px */
      background: rgba(248, 249, 250, 0.8);
    }

    .status-message.waiting {
      color: #666;
      background: rgba(248, 249, 250, 0.8);
    }

    .status-message.active {
      color: #28a745;
      background: rgba(40, 167, 69, 0.1);
    }

    @media (max-width: 1200px) {
      .exercise-session-container {
        max-width: 800px; /* Réduit */
      }
      
      .motion-visual-large {
        width: 200px; /* Réduit */
        height: 200px; /* Réduit */
      }
      
      .motion-description-large {
        max-width: 250px; /* Réduit */
        font-size: 0.85rem; /* Réduit */
      }
    }

    @media (max-width: 768px) {
      .exercise-session-container {
        gap: 0.6rem; /* Réduit */
      }

      .exercise-header {
        flex-direction: column;
        text-align: center;
        padding: 1rem; /* Réduit */
      }

      .exercise-info {
        flex-direction: column;
        gap: 0.6rem; /* Réduit */
      }

      .exercise-icon {
        width: 50px; /* Réduit */
        height: 50px; /* Réduit */
        font-size: 2rem; /* Réduit */
      }

      .exercise-details h1 {
        font-size: 1.2rem; /* Réduit */
      }

      .exercise-controls {
        width: 100%;
        justify-content: center;
        gap: 0.4rem; /* Réduit */
      }

      .btn-exercise-action {
        padding: 0.5rem 0.8rem; /* Réduit */
        font-size: 0.75rem; /* Réduit */
      }

      .motion-display {
        padding: 1rem; /* Réduit */
      }

      .motion-visual-large {
        width: 180px; /* Réduit */
        height: 180px; /* Réduit */
        margin: 0.6rem 0; /* Réduit */
      }

      .motion-visual-large.no-image {
        font-size: 2.8rem; /* Réduit */
      }

      .motion-description-large {
        font-size: 0.8rem; /* Réduit */
        padding: 0.5rem 0.6rem; /* Réduit */
        max-width: 220px; /* Réduit */
      }

      .exercise-status {
        flex-direction: column;
        padding: 0.8rem; /* Réduit */
      }

      .status-info {
        width: 100%;
        justify-content: center;
        gap: 0.8rem; /* Réduit */
      }

      .status-item {
        padding: 0.5rem 0.8rem; /* Réduit */
        min-width: 50px; /* Réduit */
      }

      .status-item strong {
        font-size: 0.9rem; /* Réduit */
      }

      .status-item span {
        font-size: 0.65rem; /* Réduit */
      }

      .status-message {
        font-size: 0.75rem; /* Réduit */
        padding: 0.5rem 0.8rem; /* Réduit */
      }
    }

    @media (max-width: 480px) {
      .exercise-header {
        padding: 0.8rem; /* Réduit */
      }

      .exercise-icon {
        width: 45px; /* Réduit */
        height: 45px; /* Réduit */
        font-size: 1.8rem; /* Réduit */
      }

      .exercise-details h1 {
        font-size: 1.1rem; /* Réduit */
      }

      .exercise-patient {
        font-size: 0.75rem; /* Réduit */
        padding: 0.15rem 0.5rem; /* Réduit */
      }

      .btn-exercise-action {
        padding: 0.4rem 0.6rem; /* Réduit */
        font-size: 0.7rem; /* Réduit */
        gap: 0.2rem; /* Réduit */
      }

      .motion-display {
        padding: 0.8rem; /* Réduit */
      }

      .motion-visual-large {
        width: 150px; /* Réduit */
        height: 150px; /* Réduit */
        margin: 0.5rem 0; /* Réduit */
      }

      .motion-visual-large.no-image {
        font-size: 2.5rem; /* Réduit */
      }

      .motion-description-large {
        font-size: 0.75rem; /* Réduit */
        padding: 0.4rem 0.5rem; /* Réduit */
        max-width: 200px; /* Réduit */
        margin-top: 0.5rem; /* Réduit */
      }

      .exercise-status {
        padding: 0.6rem; /* Réduit */
      }

      .status-info {
        gap: 0.6rem; /* Réduit */
      }

      .status-item {
        padding: 0.4rem 0.6rem; /* Réduit */
        min-width: 45px; /* Réduit */
      }

      .status-item strong {
        font-size: 0.85rem; /* Réduit */
      }

      .status-item span {
        font-size: 0.6rem; /* Réduit */
      }

      .status-message {
        font-size: 0.7rem; /* Réduit */
        padding: 0.4rem 0.6rem; /* Réduit */
      }
    }

    /* Styles pour le système d'annotation */
    .annotation-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      padding: 2rem;
      z-index: 1000;
      width: 90%;
      max-width: 400px;
    }

    .annotation-modal h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      color: #333;
    }

    .annotation-modal textarea {
      width: 100%;
      height: 80px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 0.8rem;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      resize: none;
    }

    .annotation-modal select {
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 0.6rem;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .annotation-modal button {
      width: 100%;
      padding: 0.8rem;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
    }

    .annotation-modal button:hover {
      background: linear-gradient(135deg, #0056b3, #004494);
    }

    /* Masque d'arrière-plan pour le modal */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 999;
    }
  </style>
</head>
<body>
  <h1>🏃‍♂️ Exercise Session - Nordic Thingy</h1>
  
  <div class="exercise-session-container">
    <!-- Navigation Menu -->
    <div class="navigation">
      <a href="/" class="nav-btn">
        🏠 Dashboard
      </a>
      <a href="/chart" class="nav-btn">
        📈 Charts
      </a>
      <a href="/sensors" class="nav-btn">
        🌡️ Sensors
      </a>
      <a href="/motion" class="nav-btn">
        🏃 Motion
      </a>
      <a href="/patients" class="nav-btn">
        👥 Patients
      </a>
    </div>

    <div class="exercise-header">
      <div class="exercise-info">
        <div class="exercise-icon" id="exerciseIcon">🔵</div>
        <div class="exercise-details">
          <h1 id="exerciseName">Loading Exercise...</h1>
          <div class="exercise-patient" id="patientInfo">Patient: Loading...</div>
        </div>
      </div>
      <div class="exercise-controls">
        <button class="btn-exercise-action btn-start-session" id="startExerciseBtn">
          ▶️ Start Exercise
        </button>
        <button class="btn-exercise-action btn-stop-session" id="stopExerciseBtn" style="display: none;">
          ⏹️ Stop Exercise
        </button>
        <button class="btn-exercise-action btn-download-session" id="downloadBtn" style="display: none;">
          💾 Download CSV
        </button>
        <a href="#" class="btn-exercise-action btn-back-exercises" id="backBtn">
          ← Back to Exercises
        </a>
        <button class="btn-exercise-action" id="annotationBtn">
          📝 Add Note
        </button>
      </div>
    </div>

    <div class="motion-display">
      <div id="motionVisual" class="motion-visual-large neutral">
        <img id="motionImage" src="" alt="Motion" style="display: none;">
        <span id="motionFallback">⚪</span>
      </div>
      <div id="motionDescription" class="motion-description-large neutral">
        Ready to start exercise...
      </div>
    </div>

    <div class="exercise-status">
      <div class="status-info" id="statusInfo" style="display: none;">
        <div class="status-item">
          <strong id="remainingTime">2:00</strong>
          <span>Remaining</span>
        </div>
        <div class="status-item">
          <strong id="movementCount">0</strong>
          <span>Movements</span>
        </div>
        <div class="status-item">
          <strong id="correctCount">0</strong>
          <span>Correct</span>
        </div>
        <div class="status-item">
          <strong id="incorrectCount">0</strong>
          <span>Incorrect</span>
        </div>
      </div>
      <div class="status-message waiting" id="statusMessage">
        Click "Start Exercise" to begin 2-minute motion tracking and recording
      </div>
    </div>
  </div>

  <!-- Masque d'arrière-plan pour le modal -->
  <div class="modal-backdrop" id="modalBackdrop" style="display: none;"></div>

  <script>
    class ExerciseSession {
      constructor() {
        this.exerciseType = this.getExerciseTypeFromUrl();
        this.patientId = this.getPatientIdFromUrl();
        this.patient = null;
        this.isActive = false;
        this.startTime = null;
        this.movementCount = 0;
        this.correctCount = 0;
        this.incorrectCount = 0;
        this.timer = null;
        this.updateTimer = null;
        this.exerciseTimer = null;
        this.exerciseDuration = 120; // 2 minutes in seconds
        this.currentSessionId = null;
        this.isRecording = false;
        this.downloadUrl = null;
        this.annotations = []; // Ajouter cette ligne
        
        // DOM elements
        this.exerciseIconEl = document.getElementById('exerciseIcon');
        this.exerciseNameEl = document.getElementById('exerciseName');
        this.patientInfoEl = document.getElementById('patientInfo');
        this.startBtnEl = document.getElementById('startExerciseBtn');
        this.stopBtnEl = document.getElementById('stopExerciseBtn');
        this.downloadBtnEl = document.getElementById('downloadBtn');
        this.backBtnEl = document.getElementById('backBtn');
        this.annotationBtnEl = document.getElementById('annotationBtn'); // Ajouter cette ligne
        this.motionVisualEl = document.getElementById('motionVisual');
        this.motionDescriptionEl = document.getElementById('motionDescription');
        this.motionImageEl = document.getElementById('motionImage');
        this.motionFallbackEl = document.getElementById('motionFallback');
        this.statusInfoEl = document.getElementById('statusInfo');
        this.statusMessageEl = document.getElementById('statusMessage');
        
        // Available assets
        this.availableAssets = new Set();
        
        this.init();
      }

      getExerciseTypeFromUrl() {
        const path = window.location.pathname;
        const matches = path.match(/\/exercise\/([^\/]+)\/(.+)$/);
        return matches ? matches[1] : null;
      }

      getPatientIdFromUrl() {
        const path = window.location.pathname;
        const matches = path.match(/\/exercise\/([^\/]+)\/(.+)$/);
        return matches ? matches[2] : null;
      }

      async init() {
        await this.loadAvailableAssets();
        this.loadPatientInfo();
        this.setupExerciseInfo();
        this.initEventListeners();
      }

      initEventListeners() {
        this.startBtnEl.addEventListener('click', () => this.startExercise());
        this.stopBtnEl.addEventListener('click', () => this.stopExercise());
        this.downloadBtnEl.addEventListener('click', () => this.downloadSession());
        this.annotationBtnEl.addEventListener('click', () => this.openAnnotationModal()); // Ajouter cette ligne
      }

      // Ajouter cette méthode
      openAnnotationModal() {
        // Créer le backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop';
        backdrop.id = 'modalBackdrop';
        backdrop.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 999;
        `;
        
        // Créer le modal
        const modal = document.createElement('div');
        modal.className = 'annotation-modal';
        modal.id = 'annotationModal';
        modal.innerHTML = `
          <h3>Add Session Note</h3>
          <textarea id="annotationText" placeholder="Enter your observation..." rows="4" style="width: 100%; margin: 1rem 0; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
          <select id="annotationType" style="width: 100%; margin: 0.5rem 0; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            <option value="observation">Observation</option>
            <option value="concern">Concern</option>
            <option value="improvement">Improvement</option>
            <option value="goal">Goal</option>
          </select>
          <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <button id="saveAnnotationBtn" style="flex: 1; background: #007bff; color: white; border: none; padding: 0.8rem; border-radius: 4px; cursor: pointer;">Save</button>
            <button id="cancelAnnotationBtn" style="flex: 1; background: #6c757d; color: white; border: none; padding: 0.8rem; border-radius: 4px; cursor: pointer;">Cancel</button>
          </div>
        `;
        
        // Ajouter au DOM
        document.body.appendChild(backdrop);
        document.body.appendChild(modal);
        
        // Focus sur le textarea
        document.getElementById('annotationText').focus();
        
        // Ajouter les event listeners avec les bonnes références
        document.getElementById('saveAnnotationBtn').addEventListener('click', () => {
          this.saveAnnotation();
        });
        
        document.getElementById('cancelAnnotationBtn').addEventListener('click', () => {
          this.closeAnnotationModal();
        });
        
        // Fermer avec ESC ou clic backdrop
        backdrop.addEventListener('click', () => {
          this.closeAnnotationModal();
        });
        
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            this.closeAnnotationModal();
          }
        }, { once: true }); // Important : { once: true } pour éviter les listeners multiples
      }

      // Modifier aussi la méthode saveAnnotation() pour améliorer la validation :
      saveAnnotation() {
        const textEl = document.getElementById('annotationText');
        const typeEl = document.getElementById('annotationType');
        
        if (!textEl || !typeEl) {
          console.error('❌ Annotation form elements not found');
          return;
        }
        
        const text = textEl.value.trim();
        const type = typeEl.value;
        
        if (!text) {
          alert('Please enter an annotation text.');
          textEl.focus(); // Remettre le focus sur le textarea
          return;
        }
        
        const annotation = {
          id: Date.now(),
          sessionId: this.currentSessionId || 'no-session',
          patientId: this.patientId,
          exerciseType: this.exerciseType,
          text: text,
          type: type,
          timestamp: new Date().toISOString(),
          author: 'Medical Staff'
        };
        
        // Sauvegarder localement
        this.annotations.push(annotation);
        this.saveAnnotationsToStorage();
        
        // Afficher confirmation avec plus de détails
        console.log('📝 Annotation saved:', annotation);
        
        // Fermer le modal
        this.closeAnnotationModal();
        
        // Afficher un message de succès plus discret
        this.showSuccessMessage(`Note saved: "${text.substring(0, 30)}${text.length > 30 ? '...' : ''}"`);
      }

      // Ajouter cette nouvelle méthode pour afficher les messages de succès :
      showSuccessMessage(message) {
        // Créer un toast message
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #10b981;
          color: white;
          padding: 1rem 1.5rem;
          border-radius: 8px;
          z-index: 10000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          font-size: 0.9rem;
          font-weight: 500;
          max-width: 300px;
          word-wrap: break-word;
        `;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        // Animer l'apparition
        toast.style.transform = 'translateX(100%)';
        toast.style.transition = 'transform 0.3s ease';
        
        setTimeout(() => {
          toast.style.transform = 'translateX(0)';
        }, 10);
        
        // Supprimer après 3 secondes
        setTimeout(() => {
          toast.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }, 3000);
      }

      // Améliorer la méthode closeAnnotationModal() :
      closeAnnotationModal() {
        const modal = document.getElementById('annotationModal');
        const backdrop = document.getElementById('modalBackdrop');
        
        if (modal) {
          modal.style.transform = 'translate(-50%, -50%) scale(0.9)';
          modal.style.opacity = '0';
          modal.style.transition = 'all 0.2s ease';
        }
        
        if (backdrop) {
          backdrop.style.opacity = '0';
          backdrop.style.transition = 'opacity 0.2s ease';
        }
        
        // Supprimer après l'animation
        setTimeout(() => {
          if (modal && modal.parentNode) {
            modal.parentNode.removeChild(modal);
          }
          if (backdrop && backdrop.parentNode) {
            backdrop.parentNode.removeChild(backdrop);
          }
        }, 200);
      }

      // Ajouter cette méthode
      saveAnnotationsToStorage() {
        const existingAnnotations = JSON.parse(localStorage.getItem('exercise-annotations') || '[]');
        const allAnnotations = [...existingAnnotations, ...this.annotations.filter(a => 
          !existingAnnotations.find(existing => existing.id === a.id)
        )];
        localStorage.setItem('exercise-annotations', JSON.stringify(allAnnotations));
      }

      async loadAvailableAssets() {
        try {
          const response = await fetch('/api/assets');
          if (response.ok) {
            const assets = await response.json();
            assets.forEach(asset => {
              this.availableAssets.add(asset.name);
            });
          }
        } catch (error) {
          console.error('❌ Asset loading error:', error);
        }
      }

      loadPatientInfo() {
        const stored = localStorage.getItem('nordic-thingy-patients');
        const patients = stored ? JSON.parse(stored) : [];
        this.patient = patients.find(p => p.id === this.patientId);
        
        if (this.patient) {
          this.patientInfoEl.textContent = `Patient: ${this.patient.firstName} ${this.patient.lastName}`;
          this.backBtnEl.href = `/exercises/${this.patientId}`;
        } else {
          this.patientInfoEl.textContent = `Patient: ${this.patientId}`;
          this.backBtnEl.href = '/patients';
        }
      }

      setupExerciseInfo() {
        const exercises = {
          'neck-extension': {
            name: 'Neck Extension',
            icon: '/assets/NeckExtension.png',
            fallback: '🔵'
          },
          'head-rotation': {
            name: 'Head Rotation', 
            icon: '/assets/HeadRotation.png',
            fallback: '🟢'
          }
        };

        const exercise = exercises[this.exerciseType];
        if (exercise) {
          this.exerciseNameEl.textContent = exercise.name;
          
          // Remplacer l'icône par l'image
          if (exercise.icon) {
            this.exerciseIconEl.innerHTML = `
              <img src="${exercise.icon}" alt="${exercise.name}" 
                   style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                   onerror="this.style.display='none'; this.parentElement.innerHTML='${exercise.fallback}'; this.parentElement.style.fontSize='2.5rem';">
            `;
          } else {
            this.exerciseIconEl.textContent = exercise.fallback;
          }
        } else {
          this.exerciseNameEl.textContent = 'Unknown Exercise';
          this.exerciseIconEl.innerHTML = `
            <img src="/assets/${this.exerciseType}.png" alt="Exercise" 
                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                 onerror="this.style.display='none'; this.parentElement.innerHTML='❓'; this.parentElement.style.fontSize='2.5rem';">
          `;
        }
      }

      async startExercise() {
        this.isActive = true;
        this.startTime = Date.now();
        this.movementCount = 0;
        this.correctCount = 0;
        this.incorrectCount = 0;

        // Start recording session
        await this.startRecording();

        // Update UI
        this.startBtnEl.style.display = 'none';
        this.stopBtnEl.style.display = 'inline-flex';
        this.downloadBtnEl.style.display = 'none';
        this.statusInfoEl.style.display = 'flex';
        this.statusMessageEl.textContent = 'Exercise in progress - 2:00 remaining';
        this.statusMessageEl.className = 'status-message active';
        this.motionDescriptionEl.textContent = 'Exercise started! Perform your movements...';

        // Start data fetching every second
        this.timer = setInterval(() => this.fetchMotionData(), 1000);
        
        // Update display every second
        this.updateTimer = setInterval(() => this.updateDisplay(), 1000);
        
        // Set automatic stop after 2 minutes (120 seconds)
        this.exerciseTimer = setTimeout(() => {
          this.stopExercise();
        }, this.exerciseDuration * 1000);

        console.log('✅ Exercise started for 2 minutes');
      }

      async startRecording() {
        try {
          // Create exercise session filename with patient name, date and exercise type
          const exerciseNames = {
            'neck-extension': 'NeckExtension',
            'head-rotation': 'HeadRotation'
          };
          
          const patientName = this.patient ? 
            `${this.patient.firstName}_${this.patient.lastName}` : 
            this.patientId;
          
          const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
          const exerciseName = exerciseNames[this.exerciseType] || this.exerciseType;
          
          const customSessionId = `${patientName}_${today}_${exerciseName}`;

          const response = await fetch('/api/sessions/start-exercise', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              sessionId: customSessionId,
              patientId: this.patientId,
              exerciseType: this.exerciseType,
              patientName: patientName
            })
          });

          if (!response.ok) {
            throw new Error('Error creating recording session');
          }

          const result = await response.json();
          this.currentSessionId = result.sessionId;
          this.isRecording = true;

          console.log('✅ Recording started:', this.currentSessionId);
        } catch (error) {
          console.error('❌ Recording start error:', error);
          // Remove alert - just log the warning
          console.warn('Warning: Could not start recording session, but exercise will continue.');
        }
      }

      async stopExercise() {
        this.isActive = false;
        
        // Clear all timers
        if (this.timer) {
          clearInterval(this.timer);
          this.timer = null;
        }
        if (this.updateTimer) {
          clearInterval(this.updateTimer);
          this.updateTimer = null;
        }
        if (this.exerciseTimer) {
          clearTimeout(this.exerciseTimer);
          this.exerciseTimer = null;
        }

        // Stop recording
        await this.stopRecording();

        // Update UI
        this.startBtnEl.style.display = 'inline-flex';
        this.stopBtnEl.style.display = 'none';
        this.downloadBtnEl.style.display = 'inline-flex';
        this.statusMessageEl.textContent = 'Exercise completed and recorded - Download available';
        this.statusMessageEl.className = 'status-message waiting';
        this.motionDescriptionEl.textContent = 'Exercise session ended - CSV file ready for download';

        // Show summary
        const duration = Math.floor((Date.now() - this.startTime) / 1000);
        const accuracy = this.movementCount > 0 ? Math.round((this.correctCount / this.movementCount) * 100) : 0;
        
        const summaryMessage = `Exercise Summary:\n\nDuration: ${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}\nTotal Movements: ${this.movementCount}\nCorrect Movements: ${this.correctCount}\nIncorrect Movements: ${this.incorrectCount}\nAccuracy: ${accuracy}%`;

        // Remove alert - just log to console
        console.log('Exercise completed:', summaryMessage);
        if (this.currentSessionId) {
          console.log(`Session recorded as: ${this.currentSessionId}.csv`);
        }

        console.log('✅ Exercise completed');
      }

      async stopRecording() {
        if (!this.isRecording || !this.currentSessionId) return;

        try {
          const response = await fetch(`/api/sessions/${this.currentSessionId}/stop`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          if (response.ok) {
            const result = await response.json();
            this.downloadUrl = result.downloadUrl;
            console.log('✅ Recording stopped:', this.currentSessionId);
          }
          
          this.isRecording = false;
        } catch (error) {
          console.error('❌ Recording stop error:', error);
        }
      }

      downloadSession() {
        if (this.downloadUrl && this.currentSessionId) {
          const link = document.createElement('a');
          link.href = this.downloadUrl;
          link.download = `${this.currentSessionId}.csv`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          console.log('📥 Downloaded:', `${this.currentSessionId}.csv`);
        } else {
          console.warn('⚠️ No download URL available');
        }
      }

      updateDisplay() {
        if (!this.isActive || !this.startTime) return;

        const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
        const remaining = Math.max(0, this.exerciseDuration - elapsed);
        
        const remainingMinutes = Math.floor(remaining / 60);
        const remainingSeconds = remaining % 60;
        
        // Update remaining time
        const remainingTimeEl = document.getElementById('remainingTime');
        if (remainingTimeEl) {
          remainingTimeEl.textContent = 
            `${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // Update counters
        document.getElementById('movementCount').textContent = this.movementCount;
        document.getElementById('correctCount').textContent = this.correctCount;
        document.getElementById('incorrectCount').textContent = this.incorrectCount;
        
        // Update status message
        if (remaining > 0) {
          this.statusMessageEl.textContent = 
            `Exercise in progress - ${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')} remaining`;
        } else {
          this.statusMessageEl.textContent = 'Exercise completing...';
        }
      }

      async fetchMotionData() {
        if (!this.isActive) return;

        try {
          const response = await fetch('/api/sensor-data');
          if (response.ok) {
            const data = await response.json();
            if (data.motionalert) {
              this.updateMotionDisplay(data.motionalert);
              this.analyzeMovement(data.motionalert);
            }
            
            // Record this data point
            await this.recordDataPoint();
          }
        } catch (error) {
          console.error('Error fetching motion data:', error);
        }
      }

      async recordDataPoint() {
        if (!this.isRecording || !this.currentSessionId) return;

        try {
          const response = await fetch(`/api/sessions/${this.currentSessionId}/record`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          if (!response.ok) {
            console.error('❌ Failed to record data point');
          }
        } catch (error) {
          console.error('❌ Recording error:', error);
        }
      }

      analyzeMovement(motionAlert) {
        if (!motionAlert) return;
        
        const normalized = motionAlert.toLowerCase();
        
        // Définir les positions neutres/statiques qui ne doivent pas être comptées
        const neutralPositions = [
          'neutral',
          'center_0',
          'mid_center_0',
          'high_center_0', 
          'down_center_0'
        ];
        
        // Vérifier si c'est une position neutre
        const isNeutralPosition = neutralPositions.some(neutral => 
          normalized.includes(neutral)
        );
        
        // Ne compter que les vrais mouvements (pas les positions neutres)
        if (!isNeutralPosition) {
          this.movementCount++;
          
          // Vérifier si le mouvement contient "BAD MOVEMENT"
          if (motionAlert.includes('- BAD MOVEMENT')) {
            this.incorrectCount++;
            console.log('❌ Bad movement detected:', motionAlert);
          } else {
            // Tous les mouvements qui ne sont pas "BAD MOVEMENT" et pas neutres sont corrects
            this.correctCount++;
            console.log('✅ Good movement detected:', motionAlert);
          }
          
          // Log pour debug
          console.log(`Movement analysis: Total=${this.movementCount}, Correct=${this.correctCount}, Incorrect=${this.incorrectCount}`);
        } else {
          // Log pour debug des positions neutres (optionnel)
          console.log('⚪ Neutral position (not counted):', motionAlert);
        }
      }

      formatMotionDescription(motionAlert) {
        const parts = motionAlert.split('_');
        if (parts.length >= 2) {
          const direction = parts[0];
          const position = parts[1];
          const level = parts[2] || '';

          let directionText = '';
          switch (direction) {
            case 'down': directionText = 'Head down'; break;
            case 'high': directionText = 'Head up'; break;
            case 'mid': directionText = 'Mid position'; break;
            default: directionText = direction;
          }

          let positionText = '';
          switch (position) {
            case 'center': positionText = 'center'; break;
            case 'left': positionText = 'left'; break;
            case 'right': positionText = 'right'; break;
            default: positionText = position;
          }

          const levelText = level ? ' (' + level + ')' : '';
          return `${directionText} ${positionText}${levelText}`;
        }
        
        return motionAlert;
      }

      updateMotionDisplay(motionAlert) {
        // Clear existing classes
        this.motionVisualEl.className = 'motion-visual-large';

        let fallbackIcon = '⚪';
        let description = motionAlert;
        let imageUrl = null;

        // Extract image name (remove " - BAD MOVEMENT" suffix if present)
        const imageName = motionAlert.replace(/ - BAD MOVEMENT$/i, '');

        // Look for corresponding image using the clean image name
        if (this.availableAssets.has(imageName)) {
          imageUrl = `/assets/${imageName}.png`;
          description = motionAlert; // Keep the full alert with BAD MOVEMENT
        } else {
          // Just use the raw alert
          fallbackIcon = '❓';
          description = motionAlert;
        }

        this.motionDescriptionEl.textContent = description;

        if (imageUrl) {
          this.motionImageEl.src = imageUrl;
          this.motionImageEl.style.display = 'block';
          this.motionFallbackEl.style.display = 'none';

          this.motionImageEl.onerror = () => {
            this.motionImageEl.style.display = 'none';
            this.motionFallbackEl.style.display = 'flex';
            this.motionFallbackEl.textContent = fallbackIcon;
            this.motionVisualEl.classList.add('no-image');
          };
        } else {
          this.motionImageEl.style.display = 'none';
          this.motionFallbackEl.style.display = 'flex';
          this.motionFallbackEl.textContent = fallbackIcon;
          this.motionVisualEl.classList.add('no-image');
        }
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new ExerciseSession();
    });
  </script>
</body>
</html>