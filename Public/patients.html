<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patients - Nordic Thingy</title>
  <link rel="stylesheet" href="/style/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .patients-container {
      height: calc(100vh - 100px);
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 0 auto;
      gap: 1rem;
    }

    .patients-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      padding: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .patients-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #333;
      margin: 0;
    }

    .btn-add-patient {
      padding: 0.8rem 1.5rem;
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 3px 12px rgba(40, 167, 69, 0.3);
    }

    .btn-add-patient:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    .patients-content {
      flex: 1;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      padding: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    .patients-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
    }

    .patient-card {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 12px;
      padding: 1.5rem;
      border-left: 4px solid #007bff;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      min-height: 280px; /* Added min-height to accommodate photo */
    }

    .patient-card:hover {
      transform: translateY(-2px);
    }

    .patient-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.8rem;
    }

    .patient-name {
      font-size: 1.2rem;
      font-weight: 700;
      color: #333;
      margin: 0;
      flex: 1;
    }

    .patient-id {
      font-size: 0.8rem;
      color: #666;
      background: rgba(0, 123, 255, 0.1);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      margin-left: 1rem;
    }

    .patient-info {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      flex: 1; /* Take up remaining space */
    }

    .patient-info-item {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
    }

    .patient-info-label {
      color: #666;
      font-weight: 500;
    }

    .patient-info-value {
      color: #333;
      font-weight: 600;
    }

    .patient-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* Changed from 4 to 3 buttons */
      gap: 0.4rem; /* Slightly increased gap */
      margin-top: auto;
    }

    .btn-patient-action {
      padding: 0.4rem 0.6rem; /* Slightly increased padding */
      border: none;
      border-radius: 6px;
      font-size: 0.8rem; /* Slightly larger font */
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .btn-view {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
    }

    .btn-exercise {
      background: linear-gradient(135deg, #17a2b8, #138496);
      color: white;
    }

    .btn-edit {
      background: linear-gradient(135deg, #ffc107, #e0a800);
      color: #333;
    }

    .btn-delete {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
    }

    .btn-patient-action:hover {
      transform: translateY(-1px);
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 3rem;
      color: #666;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }

    .empty-state-subtext {
      font-size: 1rem;
      opacity: 0.7;
    }

    /* Modal styles - FIXED positioning */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      overflow-y: auto; /* Allow scrolling if needed */
    }

    .modal-content {
      background: white;
      margin: 2% auto; /* Reduced from 5% to 2% */
      padding: 1.5rem; /* Reduced padding */
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 95vh; /* Added max-height constraint */
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: relative;
      overflow-y: auto; /* Allow internal scrolling */
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem; /* Reduced from 1.5rem */
      padding-bottom: 0.8rem; /* Reduced padding */
      border-bottom: 1px solid #eee;
      position: sticky; /* Keep header visible when scrolling */
      top: 0;
      background: white;
      z-index: 1;
    }

    .modal-title {
      font-size: 1.2rem; /* Reduced from 1.3rem */
      font-weight: 700;
      color: #333;
      margin: 0;
    }

    .close {
      color: #aaa;
      font-size: 1.8rem; /* Reduced from 2rem */
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover {
      color: #333;
    }

    .form-group {
      margin-bottom: 0.8rem; /* Reduced from 1rem */
    }

    .form-label {
      display: block;
      margin-bottom: 0.3rem; /* Reduced from 0.5rem */
      font-weight: 600;
      color: #333;
      font-size: 0.9rem; /* Reduced font size */
    }

    .form-input {
      width: 100%;
      padding: 0.6rem; /* Reduced from 0.8rem */
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 0.9rem; /* Reduced from 1rem */
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    .form-input:focus {
      outline: none;
      border-color: #007bff;
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1.5rem; /* Reduced from 2rem */
      padding-top: 1rem;
      border-top: 1px solid #eee;
      position: sticky; /* Keep actions visible */
      bottom: 0;
      background: white;
    }

    .btn-modal {
      padding: 0.6rem 1.2rem; /* Reduced padding */
      border: none;
      border-radius: 8px;
      font-size: 0.9rem; /* Reduced from 1rem */
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-cancel {
      background: #6c757d;
      color: white;
    }

    .btn-save {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }

    .btn-modal:hover {
      transform: translateY(-1px); /* Reduced transform */
    }

    /* Photo upload styles */
    .photo-upload-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.8rem;
    }

    .photo-preview {
      width: 120px;
      height: 120px;
      border: 2px dashed #ddd;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.3s ease;
      overflow: hidden;
      position: relative;
    }

    .photo-preview:hover {
      border-color: #007bff;
      background: #f0f8ff;
    }

    .photo-preview.has-image {
      border: 2px solid #007bff;
      background: none;
    }

    .photo-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      color: #666;
      text-align: center;
    }

    .photo-icon {
      font-size: 2rem;
    }

    .photo-text {
      font-size: 0.8rem;
      font-weight: 500;
    }

    .photo-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .form-input-file {
      display: none;
    }

    .photo-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-photo {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
    }

    .btn-photo.btn-remove {
      background: linear-gradient(135deg, #dc3545, #c82333);
    }

    .btn-photo:hover {
      transform: translateY(-1px);
    }

    /* Patient card photo styles - UPDATED */
    .patient-photo {
      width: 70px; /* Increased from 60px */
      height: 70px; /* Increased from 60px */
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #007bff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }

    .patient-photo-placeholder {
      width: 70px; /* Increased from 60px */
      height: 70px; /* Increased from 60px */
      border-radius: 50%;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem; /* Increased from 1.5rem */
      color: #666;
      border: 3px solid #ddd;
      flex-shrink: 0;
    }

    .patient-photo-icon {
      font-size: 1.8rem;
      color: #666;
    }

    .patient-header-with-photo {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.8rem;
    }

    .patient-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.8rem;
    }

    .patient-name-section {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .patients-container {
        height: calc(100vh - 80px);
        gap: 0.5rem;
      }

      .patients-header {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
      }

      .patients-list {
        grid-template-columns: 1fr;
      }

      .modal-content {
        margin: 1% auto; /* Even less margin on mobile */
        width: 95%;
        padding: 1rem; /* Reduced padding on mobile */
        max-height: 98vh; /* More height on mobile */
      }

      .form-group {
        margin-bottom: 0.6rem; /* Further reduced on mobile */
      }

      .form-input {
        padding: 0.5rem; /* Smaller padding on mobile */
      }

      .form-actions {
        flex-direction: column; /* Stack buttons on mobile */
        gap: 0.5rem;
      }

      .btn-modal {
        width: 100%; /* Full width buttons on mobile */
        padding: 0.8rem;
      }

      .patient-actions {
        grid-template-columns: repeat(2, 1fr); /* 2x2 grid on mobile */
        gap: 0.4rem;
      }

      .btn-patient-action {
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .modal-content {
        margin: 0.5% auto;
        width: 98%;
        padding: 0.8rem;
        max-height: 99vh;
      }

      .modal-header {
        margin-bottom: 0.8rem;
        padding-bottom: 0.6rem;
      }

      .modal-title {
        font-size: 1.1rem;
      }

      .close {
        font-size: 1.5rem;
      }

      .patient-actions {
        grid-template-columns: repeat(3, 1fr); /* Keep 3 buttons on mobile */
        gap: 0.3rem;
      }

      .btn-patient-action {
        padding: 0.3rem 0.4rem;
        font-size: 0.75rem;
      }
    }

    /* Ensure modal content is always within viewport */
    @media (max-height: 600px) {
      .modal-content {
        margin: 1% auto;
        max-height: 95vh;
        padding: 1rem;
      }

      .form-group {
        margin-bottom: 0.5rem;
      }

      .form-input {
        padding: 0.4rem;
        font-size: 0.85rem;
      }

      .modal-header {
        margin-bottom: 0.8rem;
        padding-bottom: 0.5rem;
      }

      .form-actions {
        margin-top: 1rem;
        padding-top: 0.8rem;
      }
    }

    /* Additional scrollbar styling for better UX */
    .modal-content::-webkit-scrollbar {
      width: 6px;
    }

    .modal-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .modal-content::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }

    .modal-content::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    .photo-upload-container {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .photo-preview {
      width: 100%;
      height: 200px;
      border: 2px dashed #007bff;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .photo-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #007bff;
      font-size: 1.2rem;
      text-align: center;
    }

    .photo-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .form-input-file {
      display: none;
    }

    .photo-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-photo {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-photo:hover {
      transform: translateY(-1px);
    }

    .btn-remove {
      background: #dc3545;
      color: white;
    }

    .btn-remove:hover {
      background: #c82333;
    }
  </style>
</head>
<body>
  <h1>👥 Patients Management - Nordic Thingy</h1>
  
  <div class="patients-container">
    <!-- Navigation Menu -->
    <div class="navigation">
      <a href="/" class="nav-btn">
        🏠 Dashboard
      </a>
      <a href="/chart" class="nav-btn">
        📈 Charts
      </a>
      <a href="/sensors" class="nav-btn">
        🌡️ Sensors
      </a>
      <a href="/motion" class="nav-btn">
        🏃 Motion
      </a>
      <a href="/patients" class="nav-btn active">
        👥 Patients
      </a>
    </div>

    <div class="patients-header">
      <h2 class="patients-title">👥 Patients List</h2>
      <button class="btn-add-patient" id="addPatientBtn">
        ➕ Add New Patient
      </button>
    </div>

    <div class="patients-content">
      <div class="patients-list" id="patientsList">
        <!-- Patients will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Add/Edit Patient Modal -->
  <div id="patientModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Add New Patient</h3>
        <span class="close" id="closeModal">&times;</span>
      </div>
      
      <form id="patientForm">
        <div class="form-group">
          <label class="form-label" for="firstName">First Name *</label>
          <input type="text" id="firstName" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="lastName">Last Name *</label>
          <input type="text" id="lastName" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="dateOfBirth">Date of Birth</label>
          <input type="date" id="dateOfBirth" class="form-input">
        </div>
        
        <div class="form-group">
          <label class="form-label" for="gender">Gender</label>
          <select id="gender" class="form-input">
            <option value="">Select Gender</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="email">Email</label>
          <input type="email" id="email" class="form-input">
        </div>
        
        <div class="form-group">
          <label class="form-label" for="phone">Phone</label>
          <input type="tel" id="phone" class="form-input">
        </div>
        
        <!-- Add photo upload section -->
        <div class="form-group">
          <label class="form-label" for="photo">Profile Photo</label>
          <div class="photo-upload-container">
            <div class="photo-preview" id="photoPreview">
              <div class="photo-placeholder">
                <span class="photo-icon">📸</span>
                <span class="photo-text">Click to add photo</span>
              </div>
            </div>
            <input type="file" id="photo" class="form-input-file" accept="image/*">
            <div class="photo-actions">
              <button type="button" class="btn-photo" id="selectPhotoBtn">
                📷 Select Photo
              </button>
              <button type="button" class="btn-photo btn-remove" id="removePhotoBtn" style="display: none;">
                🗑️ Remove
              </button>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="notes">Notes</label>
          <textarea id="notes" class="form-input" rows="3" placeholder="Additional notes about the patient..."></textarea>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-modal btn-cancel" id="cancelBtn">Cancel</button>
          <button type="submit" class="btn-modal btn-save">Save Patient</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    class PatientsManager {
      constructor() {
        this.patients = this.loadPatients();
        this.currentEditingId = null;
        
        this.initEventListeners();
        this.renderPatients();
      }

      initEventListeners() {
        // Add patient button
        document.getElementById('addPatientBtn').addEventListener('click', () => {
          this.openModal();
        });

        // Modal close buttons
        document.getElementById('closeModal').addEventListener('click', () => {
          this.closeModal();
        });
        
        document.getElementById('cancelBtn').addEventListener('click', () => {
          this.closeModal();
        });

        // Click outside modal to close
        window.addEventListener('click', (event) => {
          const modal = document.getElementById('patientModal');
          if (event.target === modal) {
            this.closeModal();
          }
        });

        // Form submission
        document.getElementById('patientForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.savePatient();
        });

        // Photo selection and removal
        document.getElementById('selectPhotoBtn').addEventListener('click', () => {
          document.getElementById('photo').click();
        });

        document.getElementById('removePhotoBtn').addEventListener('click', () => {
          this.removePhoto();
        });

        document.getElementById('photo').addEventListener('change', (e) => {
          this.handlePhotoSelect(e.target.files);
        });
      }

      loadPatients() {
        const stored = localStorage.getItem('nordic-thingy-patients');
        return stored ? JSON.parse(stored) : [];
      }

      savePatients() {
        localStorage.setItem('nordic-thingy-patients', JSON.stringify(this.patients));
      }

      generateId() {
        return 'P' + Date.now().toString().slice(-6);
      }

      openModal(patient = null) {
        const modal = document.getElementById('patientModal');
        const title = document.getElementById('modalTitle');
        const form = document.getElementById('patientForm');
        
        if (patient) {
          // Edit mode
          title.textContent = 'Edit Patient';
          this.currentEditingId = patient.id;
          this.populateForm(patient);
        } else {
          // Add mode
          title.textContent = 'Add New Patient';
          this.currentEditingId = null;
          form.reset();
        }
        
        modal.style.display = 'block';
        document.getElementById('firstName').focus();
      }

      closeModal() {
        document.getElementById('patientModal').style.display = 'none';
        document.getElementById('patientForm').reset();
        this.currentEditingId = null;
      }

      populateForm(patient) {
        document.getElementById('firstName').value = patient.firstName || '';
        document.getElementById('lastName').value = patient.lastName || '';
        document.getElementById('dateOfBirth').value = patient.dateOfBirth || '';
        document.getElementById('gender').value = patient.gender || '';
        document.getElementById('email').value = patient.email || '';
        document.getElementById('phone').value = patient.phone || '';
        document.getElementById('notes').value = patient.notes || '';

        // Photo
        const photoPreview = document.getElementById('photoPreview');
        const removePhotoBtn = document.getElementById('removePhotoBtn');
        if (patient.photo) {
          photoPreview.innerHTML = `<img src="${patient.photo}" alt="Patient Photo" style="width: 100%; height: auto; border-radius: 8px;">`;
          removePhotoBtn.style.display = 'inline-block';
        } else {
          photoPreview.innerHTML = `
            <div class="photo-placeholder">
              <span class="photo-icon">📸</span>
              <span class="photo-text">Click to add photo</span>
            </div>
          `;
          removePhotoBtn.style.display = 'none';
        }
      }

      savePatient() {
        const formData = {
          firstName: document.getElementById('firstName').value.trim(),
          lastName: document.getElementById('lastName').value.trim(),
          dateOfBirth: document.getElementById('dateOfBirth').value,
          gender: document.getElementById('gender').value,
          email: document.getElementById('email').value.trim(),
          phone: document.getElementById('phone').value.trim(),
          notes: document.getElementById('notes').value.trim(),
          photo: this.currentEditingId ? this.patients.find(p => p.id === this.currentEditingId)?.photo : null
        };

        // Get current photo from preview if it exists
        const photoPreview = document.getElementById('photoPreview');
        const photoImg = photoPreview.querySelector('img');
        if (photoImg && photoImg.src.startsWith('data:')) {
          // If it's a new base64 image, we need to upload it
          formData.photo = photoImg.src;
        }

        // Validation
        if (!formData.firstName || !formData.lastName) {
          alert('First name and last name are required!');
          return;
        }

        // If there's a new photo to upload
        if (formData.photo && formData.photo.startsWith('data:')) {
          this.uploadPhoto(formData);
        } else {
          this.savePatientData(formData);
        }
      }

      async uploadPhoto(formData) {
        try {
          const patientId = this.currentEditingId || this.generateId();
          
          const response = await fetch('/api/patients/upload-photo-base64', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              photoData: formData.photo,
              patientId: patientId
            })
          });

          if (!response.ok) {
            throw new Error('Photo upload failed');
          }

          const result = await response.json();
          
          // Update formData with server photo URL
          formData.photo = result.photoUrl;
          formData.photoFilename = result.filename;
          
          this.savePatientData(formData);
        } catch (error) {
          console.error('Photo upload error:', error);
          alert('Error uploading photo: ' + error.message);
        }
      }

      savePatientData(formData) {
        if (this.currentEditingId) {
          // Update existing patient
          const index = this.patients.findIndex(p => p.id === this.currentEditingId);
          if (index !== -1) {
            // Delete old photo if it exists and we're replacing it
            const oldPatient = this.patients[index];
            if (oldPatient.photoFilename && formData.photoFilename && oldPatient.photoFilename !== formData.photoFilename) {
              this.deletePhoto(oldPatient.photoFilename);
            }
            
            this.patients[index] = {
              ...this.patients[index],
              ...formData,
              updatedAt: new Date().toISOString()
            };
          }
        } else {
          // Add new patient
          const newPatient = {
            id: this.currentEditingId || this.generateId(),
            ...formData,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          this.patients.push(newPatient);
        }

        this.savePatients();
        this.renderPatients();
        this.closeModal();
      }

      async deletePhoto(filename) {
        try {
          await fetch(`/api/patients/delete-photo/${filename}`, {
            method: 'DELETE'
          });
        } catch (error) {
          console.error('Error deleting photo:', error);
        }
      }

      async deletePatient(id) {
        const patient = this.patients.find(p => p.id === id);
        // Remove confirm dialog - just proceed with deletion
        if (patient) {
          // Delete photo file if it exists
          if (patient.photoFilename) {
            await this.deletePhoto(patient.photoFilename);
          }

          this.patients = this.patients.filter(p => p.id !== id);
          this.savePatients();
          this.renderPatients();
        }
      }

      calculateAge(dateOfBirth) {
        if (!dateOfBirth) return 'N/A';
        const today = new Date();
        const birthDate = new Date(dateOfBirth);
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }
        return age + ' years';
      }

      renderPatients() {
        const container = document.getElementById('patientsList');
        
        if (this.patients.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">👥</div>
              <div class="empty-state-text">No patients yet</div>
              <div class="empty-state-subtext">Click "Add New Patient" to get started</div>
            </div>
          `;
          return;
        }

        container.innerHTML = this.patients.map(patient => `
          <div class="patient-card">
            ${patient.photo ? `
              <div class="patient-header-with-photo">
                <img src="${patient.photo}" alt="${patient.firstName} ${patient.lastName}" class="patient-photo">
                <div class="patient-name-section">
                  <h3 class="patient-name">${patient.firstName} ${patient.lastName}</h3>
                  <span class="patient-id">${patient.id}</span>
                </div>
              </div>
            ` : `
              <div class="patient-header">
                <div class="patient-photo-placeholder">
                  <span class="patient-photo-icon">👤</span>
                </div>
                <div class="patient-name-section">
                  <h3 class="patient-name">${patient.firstName} ${patient.lastName}</h3>
                  <span class="patient-id">${patient.id}</span>
                </div>
              </div>
            `}
            
            <div class="patient-info">
              <div class="patient-info-item">
                <span class="patient-info-label">Age:</span>
                <span class="patient-info-value">${this.calculateAge(patient.dateOfBirth)}</span>
              </div>
              <div class="patient-info-item">
                <span class="patient-info-label">Gender:</span>
                <span class="patient-info-value">${patient.gender || 'N/A'}</span>
              </div>
              <div class="patient-info-item">
                <span class="patient-info-label">Email:</span>
                <span class="patient-info-value">${patient.email || 'N/A'}</span>
              </div>
              <div class="patient-info-item">
                <span class="patient-info-label">Phone:</span>
                <span class="patient-info-value">${patient.phone || 'N/A'}</span>
              </div>
              <div class="patient-info-item">
                <span class="patient-info-label">Created:</span>
                <span class="patient-info-value">${new Date(patient.createdAt).toLocaleDateString()}</span>
              </div>
            </div>
            
            <div class="patient-actions">
              <button class="btn-patient-action btn-exercise" onclick="patientsManager.openExercises('${patient.id}')">
                🏃‍♂️ Exercise
              </button>
              <button class="btn-patient-action btn-edit" onclick="patientsManager.editPatient('${patient.id}')">
                ✏️ Edit
              </button>
              <button class="btn-patient-action btn-delete" onclick="patientsManager.deletePatient('${patient.id}')">
                🗑️ Delete
              </button>
            </div>
          </div>
        `).join('');
      }

      editPatient(id) {
        const patient = this.patients.find(p => p.id === id);
        if (patient) {
          this.openModal(patient);
        }
      }

      openExercises(id) {
        // Redirect to exercises page for specific patient
        window.location.href = `/exercises/${id}`;
      }

      handlePhotoSelect(files) {
        const file = files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const photoPreview = document.getElementById('photoPreview');
            photoPreview.innerHTML = `<img src="${e.target.result}" alt="Patient Photo" style="width: 100%; height: auto; border-radius: 8px;">`;
            document.getElementById('removePhotoBtn').style.display = 'inline-block';
          };
          reader.readAsDataURL(file);
        }
      }

      removePhoto() {
        document.getElementById('photoPreview').innerHTML = `
          <div class="photo-placeholder">
            <span class="photo-icon">📸</span>
            <span class="photo-text">Click to add photo</span>
          </div>
        `;
        document.getElementById('removePhotoBtn').style.display = 'none';
        document.getElementById('photo').value = ''; // Clear file input
      }
    }

    // Initialize the patients manager
    let patientsManager;
    document.addEventListener('DOMContentLoaded', () => {
      patientsManager = new PatientsManager();
    });
  </script>
</body>
</html>